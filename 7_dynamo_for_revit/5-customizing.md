# 自訂

我們先前對編輯基本建築量體進行瞭解時，希望一次編輯大量元素，以更深入地探究 Dynamo/Revit 連結。大規模自訂變得更加複雜，因為資料結構需要更高級的清單作業。但是，此作業所遵循的基本原則在本質上並無不同。接下來針對一組自適應元件瞭解分析的某些因素。

### 點位置

假設我們已建立一系列自適應元件，希望根據其點位置來編輯參數。例如，點可以驅動與元素面積相關的厚度參數。或者，點可以驅動與全年日曬相關的不透明度參數。藉由 Dynamo，可以使用一些簡單的步驟將分析連接至參數，我們將在以下練習中探究基本版本。

![](./images/5/customizing-pointlocation.jpg)

> 使用 **AdaptiveComponent.Locations** 節點查詢所選自適應元件的自適應點。這可讓我們使用提取出的 Revit 元素進行分析。

透過萃取自適應元件的點位置，我們可以對該元素執行一系列分析。藉由四點自適應元件，您可以針對諸如指定面板等物件研究平面的偏差。

### 太陽方位分析

![](./images/5/customizing-solarorientationanalysis.jpg)

> 使用重新對映將一組資料對映到參數範圍。這是參數式模型中使用的基本工具，我們將在以下練習中展示該工具。

使用 Dynamo，自適應元件的點位置可用於建立每個元素的最佳擬合平面。我們也可以在 Revit 檔案中查詢日光位置，研究平面相對於日光的方位，並與其他自適應元件進行比較。在以下的練習中，我們將建立由演算法控制的屋頂，以設置該功能。

## 練習

> 按一下下方的連結下載範例檔案。
>
> 附錄中提供範例檔案的完整清單。

{% file src="./datasets/5/Revit-Customizing.zip" %}

此練習將詳細說明上一節中示範的技巧。在此案例中，我們將使用 Revit 元素定義參數式曲面，同時實體化四點自適應元件，然後根據太陽方位對其進行編輯。

![](./images/5/customizing-exercise01.jpg)

> 1. 先選取兩條邊與_「Select Edge」_節點。兩條邊是中庭的長跨距。
> 2. 使用 _List.Create_ 節點將兩條邊合併到一個清單中。
> 3. 使用 _Surface.ByLoft_ 在兩條邊之間建立曲面。

![](./images/5/customizing-exercise02.jpg)

> 1. 使用 _Code Block_，定義從 0 至 1 的範圍 (包含均勻分佈的 10 個值)：`0..1..#10;`
> 2. 將 _Code Block_ 插入 _Surface.PointAtParameter_ 節點的 *u* 與 _v_ 輸入，並將 _Surface.ByLoft_ 節點插入 _surface_ 輸入。在節點上按一下右鍵，將 _交織_ 變更為 _「笛卡兒積」_。這將在曲面上產生點的網格。

此點網格可作為以參數式方式定義之曲面的控制點。我們希望萃取其中每個點的 u 與 v 位置，以便能將其插入至參數式公式，並保留相同的資料結構。我們可以查詢剛剛建立點的參數位置，以執行此作業。

![](./images/5/customizing-exercise03.jpg)

> 1. 在圖元區加入 _Surface.ParameterAtPoint_ 節點，連接輸入，如上所示。
> 2. 使用 UV.U 節點查詢這些參數的 _u_ 值。
> 3. 使用 UV.V 節點查詢這些參數的 _v_ 值。
> 4. 輸出會顯示每個曲面點的對應 _u_ 與 _v_ 值。現在我們已取得所需範圍，每個值都介於 _0_ 與 _1_ 之間，並具有正確的資料結構，我們已準備好套用參數式演算法。

![](./images/5/customizing-exercise04.jpg)

> 1. 在圖元區加入 _Code Block_，然後輸入程式碼：`Math.Sin(u*180)*Math.Sin(v*180)*w;`。這是一個參數式函數，可從平面建立正弦凸塊。
> 2. 將 _UV.U_ 連接至 _u_ 輸入，將 UV.V 連接至 _v_ 輸入。
> 3. _w_ 輸入表示形狀的 _幅度_，因此我們為其連接 _Number Slider_。

![](./images/5/customizing-exercise05.jpg)

> 1. 現在，我們有一個由演算法定義的值清單。接下來使用此值清單在 _+Z_ 方向將點上移。使用 _Geometry.Translate_，將 *Code Block* 插入 _zTranslation_，並將 _Surface.PointAtParameter_ 插入 _geometry_ 輸入。您應該會看到新的點顯示在 Dynamo 預覽中。
> 2. 最後，我們使用 _NurbsSurface.ByPoints_ 節點建立曲面，將上一步驟中的節點插入 points 輸入。我們建立了自己的參數式曲面。自由拖曳滑棒，觀看凸塊的收縮與膨脹。

使用參數式曲面，我們要定義將其面板化的方式，以排列四點自適應元件。Dynamo 沒有即裝即用的曲面平板化功能，因此我們可以尋找社群是否有實用的 Dynamo 套件。

![](./images/5/customizing-exercise06.jpg)

> 1. 移至 _「套件」>「搜尋套件...」_
> 2. 搜尋 _LunchBox_，並安裝 _LunchBox for Dynamo_。對於諸如此類的幾何圖形作業，這是非常有用的一組工具。

> 1. 下載之後，您現在可以完整存取 LunchBox 套件。搜尋 _Quad Grid_，然後選取 _LunchBox Quad Grid By Face_。將參數式曲面插入至 _surface_ 輸入，並將 _U_ 與 _V_ 分割份數設定為 _15_。您在 Dynamo 預覽中應該會看到一個有四邊形平板的曲面。

> 如果您對其設置感到好奇，可以按兩下 _Lunch Box_ 節點，並查看其內容。

> 返回 Revit，接下來快速查看我們將在這裡使用的自適應元件。無需沿其作業，但這是我們將要實體化的屋頂面板。它是四點自適應元件，是 ETFE 系統的粗略表示。中心空心的鎖點框與稱為 _ApertureRatio_ 的參數有關。

> 1. 我們將在 Revit 中實體化大量幾何圖形，因此請確保將 Dynamo 求解器調整為 _「手動」_。
> 2. 在圖元區加入 _Family Types_ 節點，然後選取 _「ROOF-PANEL-4PT」_。
> 3. 在圖元區加入 _AdaptiveComponent.ByPoints_ 節點，將 _Panel Pts_ 從 _LunchBox Quad Grid by Face_ 輸出連接至 _points_ 輸入。將 _Family Types_ 節點連接至 _familySymbol_ 輸入。
> 4. 按一下 _「執行」_。建立幾何圖形時，Revit 需要_考慮_一段時間。若花費太長時間，請將 _Code Block 的「15」_ 減少為較小的數字。這將減少屋頂上面板的數量。

_注意：若 Dynamo 花費很長時間來計算節點，您可能要在開發圖表時，使用「凍結」節點功能以暫停所執行的 Revit 作業。如需有關凍結節點的更多資訊，請參閱〈實體〉一章中的〈凍結〉一節。_

> 返回 Revit，我們已在屋頂上建立一系列面板。

> 拉近，我們可以更近地查看其曲面品質。

### 分析

> 1. 從上一步繼續執行，接下來更進一步，根據其日曬時間驅動每個面板的孔徑。拉近至 Revit，選取一個面板，可以看到在性質列中，有一個名為 _Aperture Ratio_ 的參數。設置族群，讓孔徑的範圍大致介於 _0.05_ 到 _0.45_ 之間。

> 1. 如果打開太陽路徑，可以在 Revit 中看到目前的太陽位置。

> 1. 我們可以使用 _SunSettings.Current_ 節點參考此太陽位置。

1. 將太陽設定插入 _Sunsetting.SunDirection_ 以取得太陽向量。
2. 從用於建立自適應元件的 _Panel Pts_ 中，使用 _Plane.ByBestFitThroughPoints_ 近似元件的平面。
3. 查詢此平面的 _法向_。
4. 使用 _內積_ 計算太陽方位。內積是一個決定兩個向量平行程度的公式。我們將取得每個自適應元件的平面法向，並與太陽向量進行比較，以粗略模擬太陽方位。
5. 採用結果的 _絕對值_。這可確保在平面法向指向相反方向時，內積是準確的。
6. 按一下 _「執行」_ 。

> 1. 看看 _內積_ ，我們產生了許多數字。我們希望使用其相對分佈，但需要將這些數字縮攏到我們想要編輯的 _Aperture Ratio_ 參數的適當範圍內。

1. _Math.RemapRange_ 是執行此作業的強大工具。它採用輸入清單，並將邊界重新對映到兩個目標值。
2. 在 _Code Block_ 中，將目標值定義為 _0.15_ 與 _0.45_。
3. 按一下 _「執行」_ 。

> 1. 將重新對映的值連接至 _Element.SetParameterByName_ 節點。

1. 將字串 _Aperture Ratio_ 連接至 _parameterName_ 輸入。
2. 將 _adaptive components_ 連接至 _element_ 輸入。
3. 按一下 _「執行」_ 。

> 返回 Revit，透過距離，我們可以瞭解太陽方位對 ETFE 面板孔徑產生的影響。

> 拉近，我們可以看到在面向日光時，ETFE 面板更為封閉。此時我們的目標是減少日曬帶來的過熱。如果我們根據日曬而希望讓更多光線進入，只需在 _Math.RemapRange_ 上切換範圍即可。
