# Адаптация

Ранее мы рассмотрели редактирование базового формообразующего элемента здания. Теперь мы предлагаем подробнее изучить взаимодействие Dynamo и Revit путем редактирования большого количества элементов за один подход. Адаптация усложняется при увеличении масштаба, так как структура данных требует более сложных операций со списками. Однако основные принципы работы при этом остаются прежними. Рассмотрим возможности расчета с помощью набора адаптивных компонентов.

### Местоположение точки

Предположим, что вы создали набор адаптивных компонентов и хотите отредактировать параметры на основании местоположений точек. Например, точки могут определять параметр толщины, который связан с площадью элемента. Кроме того, они могут отвечать за параметр непрозрачности, связанный с уровнем инсоляции за год. Dynamo позволяет связать расчет с параметрами за несколько простых шагов. Основы этого процесса будут приведены в упражнениях ниже.

![](./images/5/customizing-pointlocation.jpg)

> Опросите адаптивные точки выбранного адаптивного компонента с помощью узла **AdaptiveComponent.Locations**. Это позволяет выполнить расчет для абстрагированной версии элемента Revit.

Получив местоположение точек адаптивных компонентов, можно запустить несколько расчетов для элемента. Например, адаптивный компонент по четырем точкам позволяет изучить отклонение от плоскости для заданной панели.

### Расчет ориентации относительно солнца

![](./images/5/customizing-solarorientationanalysis.jpg)

> Используя повторное сопоставление, можно сопоставить набор данных с диапазоном параметров. Это основной инструмент параметрического моделирования, который вы сможете изучить подробнее, выполнив упражнение ниже.

В Dynamo местоположения точек адаптивных компонентов можно использовать для создания плоскости наилучшего вписывания для каждого элемента. Кроме того, можно запросить положение солнца в файле Revit и изучить относительную ориентацию плоскости к солнцу по сравнению с другими адаптивными компонентами. Давайте выполним это путем создания алгоритмической кровли в упражнении ниже.

## Упражнение

> Скачайте файл примера, щелкнув указанную ниже ссылку.
>
> Полный список файлов примеров можно найти в приложении.

{% file src="./datasets/5/Revit-Customizing.zip" %}

В данном упражнении будут подробнее рассмотрены техники из предыдущего раздела. Вам понадобится определить параметрическую поверхность на основе элементов Revit, создать экземпляры адаптивных компонентов по четырем точкам, а затем отредактировать их на основании ориентации относительно солнца.

![](./images/5/customizing-exercise01.jpg)

> 1. Для начала выберите два ребра с помощью узла _Select Edge_. Два ребра представляют собой длинные пролеты атриума.
> 2. Объедините два ребра в один список, используя узел _List.Create_.
> 3. Создайте поверхность между двумя ребрами с помощью узла _Surface.ByLoft_.

![](./images/5/customizing-exercise02.jpg)

> 1. В узле _Code Block_ задайте диапазон от 0 до 1 с 10 равномерно распределенными значениями: `0..1..#10;`.
> 2. Соедините _Code Block_ с портами ввода \*u\* и _v_ узла _Surface.PointAtParameter_, а также соедините узел _Surface.ByLoft_ с портом ввода _surface_. Щелкните узел правой кнопкой мыши и задайте для параметра _Переплетение_ значение _Векторное произведение_. На поверхности появится сетка из точек.

Эта сетка из точек служит в качестве управляющих точек для параметрической поверхности. Необходимо извлечь положения u и v каждой из этих точек, чтобы ввести их в параметрическую формулу и сохранить существующую структуру данных. Это можно сделать, запросив местоположения параметров только что созданных точек.

![](./images/5/customizing-exercise03.jpg)

> 1. Добавьте узел _Surface.ParameterAtPoint_ в рабочую область и соедините порты ввода, как показано выше.
> 2. Запросите значения _u_ для этих параметров с помощью узла UV.U.
> 3. Запросите значения _v_ для этих параметров с помощью узла UV.V.
> 4. В выходных данных отображаются соответствующие значения _u_ и _v_ для каждой точки поверхности. Вы получили диапазон от _0_ до _1_ для каждого значения, обеспечена правильная структура данных, и можно применять параметрический алгоритм.

![](./images/5/customizing-exercise04.jpg)

> 1. Добавьте узел _Code Block_ в рабочую область и введите код: `Math.Sin(u*180)*Math.Sin(v*180)*w;`. Это параметрическая функция, которая создает синусоидальную выпуклость на основе плоской поверхности.
> 2. Соедините _UV.U_ с входным параметром _u_ и UV.V с входным параметром _v_.
> 3. Порт ввода _w_ представляет _амплитуду_ формы, поэтому к нему нужно присоединить узел _Number Slider_.

![](./images/5/customizing-exercise05.jpg)

> 1. Теперь у вас есть список значений в соответствии с алгоритмом. Используйте этот список для перемещения точек вверх по оси _+Z_. Используя узел _Geometry.Translate_, соедините *Code Block* с портом ввода _zTranslation_, а _Surface.PointAtParameter_ — с портом ввода _geometry_. В области предварительного просмотра Dynamo отображаются новые точки.
> 2. Наконец, создайте поверхность с помощью узла _NurbsSurface.ByPoints_, соединив узел из предыдущего шага с портом ввода points. В результате получается параметрическая поверхность. Перетаскивайте регулятор, чтобы уменьшить или увеличить выпуклость.

Теперь нам нужно найти способ разбить полученную параметрическую поверхность на панели, чтобы разместить адаптивные компоненты по четырем точкам в формате массива. В Dynamo нет готовой функции для работы с панелями, поэтому обратимся к сообществу пользователей за полезными пакетами Dynamo.

![](./images/5/customizing-exercise06.jpg)

> 1. Перейдите к разделу _«Пакеты» > «Поиск пакета...»_.
> 2. Найдите _LunchBox_ и скачайте файл _LunchBox for Dynamo_. Это очень полезный набор инструментов для подобных операций с геометрией.

> 1. После скачивания вы получите полный доступ к пакету LunchBox. Найдите _Quad Grid_ и выберите _LunchBox Quad Grid By Face_. Соедините параметрическую поверхность с портом ввода _surface_ и установите деления _U_ и _V_ на _15_. В области предварительного просмотра Dynamo должна отобразиться поверхность с прямоугольными панелями.

> Если вас заинтересовала ее настройка, дважды щелкните узел _Lunch Box_ и просмотрите параметры.

> Вернитесь в Revit, чтобы узнать, какой адаптивный компонент используется в этой программе. Нет необходимости его повторять, но это панель крыши, которая будет использоваться в качестве экземпляра массива. Это адаптивный компонент по четырем точкам, который является грубым представлением системы ЭТФЭ. Апертура центральной полости находится на параметре _ApertureRatio_.

> 1. Так как вы собираетесь создать большое количество экземпляров геометрии в Revit, убедитесь, что решатель Dynamo находится в _ручном_ режиме.
> 2. Добавьте узел _Family Types_ в рабочую область и выберите _ROOF-PANEL-4PT_.
> 3. Добавьте узел _AdaptiveComponent.ByPoints_ в рабочую область, соедините порт вывода _Panel Pts_ узла _LunchBox Quad Grid by Face_ с портом ввода _points_. Соедините узел _Family Types_ с портом ввода _familySymbol_.
> 4. Нажмите кнопку _Запуск_. Для создания геометрии программе Revit потребуется немного времени _на раздумья_. Если это занимает слишком много времени, слегка уменьшите значение 15 в узле _Code Block_. Это уменьшит количество панелей на крыше.

_Примечание. Если Dynamo требуется много времени для расчета узлов, возможно, вам следует воспользоваться функцией заморозки, чтобы поставить на паузу выполнение операций Revit во время создания графика. Дополнительные сведения о замораживании узлов см. в разделен «Замораживание» в главе «Тела»._

> В Revit мы видим массив панелей на крыше.

> Увеличив масштаб, можно детально рассмотреть свойства их поверхности.

### Анализ

> 1. Используя результаты, полученные на предыдущем шаге, настройте апертуру каждой панели с учетом инсоляции. Увеличьте масштаб в Revit и выберите одну панель, чтобы увидеть на панели свойств параметр _Коэффициент апертуры_. В настройках семейства задан диапазон апертуры от _0,05_ до _0,45_.

> 1. Если включить траекторию солнца, можно увидеть текущее положение солнца в Revit.

> 1. С помощью узла _SunSettings.Current_ можно задать положение солнца в качестве опорного значения.

1. Соедините узел SunSettings с узлом _Sunsetting.SunDirection_, чтобы получить вектор солнца.
2. На основе значения, полученного из порта вывода _Panel Pts_, использованного для создания адаптивных компонентов, выполните аппроксимацию плоскости для компонента с помощью узла _Plane.ByBestFitThroughPoints_.
3. Запросите _нормаль_ этой плоскости.
4. Для расчета ориентации инсоляции используйте _скалярное произведение_. Скалярное произведение — это формула, которая определяет, насколько параллельны или не параллельны два вектора. Чтобы приблизительно смоделировать ориентацию инсоляции, вы сравниваете нормаль плоскости каждого адаптивного компонента с вектором солнца.
5. Извлеките _абсолютное значение_ результата. Это гарантирует точность скалярного произведения, если нормаль плоскости повернута в обратном направлении.
6. Нажмите кнопку _Запуск_.

> 1. _Скалярное произведение_ предоставляет широкий диапазон чисел. Нужно использовать их относительное распределение, однако необходимо объединить числа в соответствующем диапазоне редактируемого параметра _Коэффициент апертуры_.

1. Узел _Math.RemapRange_ отлично для этого подходит. Он извлекает список входных данных и сопоставляет его пределы с двумя целевыми значениями.
2. Задайте целевые значения _0,15_ и _0,45_ с помощью узла _Code Block_.
3. Нажмите кнопку _Запуск_.

> 1. Соедините сопоставленные значения с узлом _Element.SetParameterByName_.

1. Соедините строку _Aperture Ratio_ с портом ввода _parameterName_.
2. Соедините _адаптивные компоненты_ с портом ввода _element_.
3. Нажмите кнопку _Запуск_.

> Уменьшив масштаб в Revit, можно изучить влияние ориентации солнца на апертуру панелей ЭТФЭ.

> При увеличении изображения видно, что панели ЭТФЭ более закрыты по направлению солнца. Цель данного упражнения — уменьшить перегрев из-за инсоляции. Если требуется увеличить проникновение света в помещение на основании инсоляции, просто смените область на _Math.RemapRange_.
