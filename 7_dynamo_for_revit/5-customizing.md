# カスタマイズ

ここまで、基本的な建物のマスを編集する方法について紹介してきました。ここからは、多数の要素を一度に編集することで Dynamo と Revit のリンクについてより深く掘り下げていきましょう。カスタマイズする対象の規模が拡大すると、リストのデータ構造においてより高度な操作が要求されるので、カスタマイズの操作がより複雑になります。ただし、それを実行する背景で駆動している原理原則は、根本的にはこれまでと変わりありません。検討のために、アダプティブ コンポーネントのセットからいくつかの事例を取り上げてみましよう。

### 点の位置

アダプティブ コンポーネントを既に作成したという前提で、これからその点群の位置に基づいてパラメータを編集していくことにします。点群により、たとえば、要素の領域にかかわる厚みのパラメータをコントロールすることができます。また、太陽光の年間露光量にかかわる透過性のパラメータをコントロールすることもできます。Dynamo では、少ない手順で簡単に解析結果をパラメータに渡すことができます。次の演習でその基本的な手順を実践してみましょう。

![](./images/5/customizing-pointlocation.jpg)

> **AdaptiveComponent.Locations** ノードを使用して、選択したアダプティブ コンポーネントのアダプティブ点のクエリーを実行します。これにより、Revit の要素を解析用に抽出したバージョンを使用して作業することができます。

アダプティブ コンポーネントを構成する点の位置を抽出することで、その要素に関するさまざまな解析を行うことができます。4 点構成のアダプティブ コンポーネントにより、たとえば指定したパネルにおける水平面からの偏差を検討することができます。

### 太陽の向きの解析

![](./images/5/customizing-solarorientationanalysis.jpg)

> 再マッピング機能を使用すると、一連のデータ セットを一定のパラメータ範囲にマッピングすることができます。これはパラメトリック モデリングで使用する基本的なツールです。これ以降の演習で実際に扱ってみることにします。

Dynamo を使用すると、アダプティブ コンポーネントを構成する点群の位置から、要素ごとに最も適した平面を作成することができます。さらに Revit ファイル内の太陽の位置を参照して、太陽に対するその平面の向きを、他のアダプティブ コンポーネントと比較しながら検討することもできます。これ以降の演習で、アルゴリズムに基づいて屋根の形状を生成することで、その設定を行っていきましょう。

## 演習

> 下のリンクをクリックして、サンプル ファイルをダウンロードします。
>
> すべてのサンプル ファイルの一覧については、付録を参照してください。

{% file src="./datasets/5/Revit-Customizing.zip" %}

この演習では、前のセクションで紹介したテクニックについて詳しく説明します。このケースでは、Revit の要素からパラメトリック サーフェスを設定して、4 点構成のアダプティブ コンポーネントをインスタンス化し、太陽に対する向きに基づいて編集します。

![](./images/5/customizing-exercise01.jpg)

> 1. まず、_Select Edge_ ノードを使用して 2 本のエッジを選択します。2 本のエッジはアトリウムの長辺です。
> 2. _List.Create_ ノードを使用して、2 本のエッジを組み合わせて 1 つのリストを作成します。
> 3. _Surface.ByLoft_ ノードを使用して、2 本のエッジの間に 1 つのサーフェスを作成します。

![](./images/5/customizing-exercise02.jpg)

> 1. _Code Block_ ノードを使用して、0 から 1 までの範囲を 10 等分した値 `0..1..#10;` に指定します。
> 2. _Code Block_ ノードから _Surface.PointAtParameter_ ノードの *u * 入力と _v_ 入力に接続し、_Surface.ByLoft_ ノードを _surface_ 入力に接続します。ノードを右クリックして、_レーシング_を[_直積_]に変更します。これで、サーフェス上の点群から構成されるグリッドを取得できるようになります。

この点群によるグリッドは、パラメータに基づいて設定されたサーフェスの制御点として機能します。これら各点の位置を u と v の値として抽出することで、その値をパラメータの式に代入し、同一のデータ構造を保持できます。これを行うには、先ほど作成した点群の位置のパラメータをクエリーする必要があります。

![](./images/5/customizing-exercise03.jpg)

> 1. _Surface.ParameterAtPoint_ ノードをキャンバスに追加し、その入力を上図のように接続します。
> 2. UV.U ノードを使用して、上記のパラメータの _u_ の値をクエリーします。
> 3. UV.V ノードを使用して、上記のパラメータの _v_ の値をクエリーします。
> 4. サーフェス上のすべての点に対応する _u_ と _v_ の値が出力されます。これで、適切なデータ構造で _0_ から _1_ までの範囲で各値を取得したので、パラメトリック アルゴリズムを適用する準備ができました。

![](./images/5/customizing-exercise04.jpg)

> 1. キャンバスに _Code Block_ ノードを追加して、次のコードを入力します。`Math.Sin(u*180)*Math.Sin(v*180)*w;` これは、平坦なサーフェスから正弦波状の隆起を作成するパラメトリック関数です。
> 2. _UV.U_ を _u_ 入力に、UV.V を _v_ 入力に接続します。
> 3. _w_ 入力は形状の_振幅_を表します。そのため、ここには _Number Slider_ を接続します。

![](./images/5/customizing-exercise05.jpg)

> 1. ここまでの手順で、アルゴリズムによって定義された値のリストを取得することができました。この値のリストを使用して、点群を _Z_ の正の向きに動かしましょう。_Geometry.Translate_ を使用して、\\*Code Block \\* ノードを _zTranslation_ 入力に、_Surface.PointAtParameter_ ノードを _geometry_ 入力に接続します。Dynamo のプレビューに新しい点群が表示されるはずです。
> 2. 最後に、前の手順から _NurbsSurface.ByPoints_ ノードの points 入力に接続することで、サーフェスを作成します。こうしてパラメトリック サーフェスができあがりました。スライダを自由に動かして、隆起面が上下するのを確認してください。

パラメトリック サーフェスを使用して、その曲面を多数の小さなパネルから成る構造に変換する方法を設定し、4 点構成のアダプティブ コンポーネントを配列していきましょう。Dynamo で提供されている既定のノードには、サーフェスを多面構造に変換する機能をもつものはありません。そこで、コミュニティにアクセスして便利な Dynamo パッケージを入手しましょう。

![](./images/5/customizing-exercise06.jpg)

> 1. _[パッケージ] > [パッケージの検索]_に進みます。
> 2. 「_LunchBox_」のキーワードで検索し、「_LunchBox for Dynamo_」をインストールします。このパッケージは、この種のジオメトリ操作にじつに役に立つツール セットです。

> 1. ダウンロードすると、LunchBox スイートに完全にアクセスできるようになります。「_Quad Grid_」を検索し、_LunchBox Quad Grid By Face_ ノードを選択します。このノードの _surface_ 入力にパラメトリック サーフェスを接続し、_U_ 区分と _V_ 区分を _15_ に設定します。複数の長方形のパネルから成るサーフェスが Dynamo のプレビューに表示されます。

> 構成の詳細については、_Lunch Box_ ノードをダブルクリックして確認してください。

> Revit に戻って、ここで使用しているアダプティブ コンポーネントを簡単に確認しておきましょう。必ずしも実際に確認する必要はありませんが、いずれにせよこれからインスタンス化する対象であるこのコンポーネントは屋根のパネルです。この 4 点構成のアダプティブ コンポーネントは、ETFE システムをおおまかに表現しています。中央の開口部は _ApertureRatio_ というパラメータによってコントロールされています。

> 1. これから Revit 内の多数のジオメトリをインスタンス化するので、必ず事前に Dynamo のソルバを[_手動_]に切り替えてください。
> 2. _Family Types_ ノードをキャンバスに追加し、[_ROOF-PANEL-4PT_]を選択します。
> 3. _AdaptiveComponent.ByPoints_ ノードをキャンバスに追加し、その _points_ 入力に _LunchBox Quad Grid by Face_ ノードの _Panel Pts_ 出力を接続します。_familySymbol_ 入力に _Family Types_ ノードを接続します。
> 4. [_実行_]をクリックします。Revit はジオメトリの作成中に計算に_少々時間をかける_必要があります。あまりにも時間がかかりすぎている場合、_Code Block ノードの「15」の値を_より小さな数に減らしてください。これを行うと、屋根の部分に使用されるパネルの数が減少します。

_注: Dynamo でノードの計算に膨大な時間がかかる場合は、ノードをフリーズする機能を使用して、グラフの開発中に Revit 関連操作の実行を停止することができます。ノードをフリーズする操作の詳細については、「ソリッド」の章の「フリーズ」セクションを参照してください。_

> Revit に戻ると、屋根の上にバネルの配列が出現しています。

> 拡大表示すると、サーフェスの品質を詳細に確認できます。

### 解析

> 1. 前の手順からさらに先へと進み、各パネルが太陽光を浴びている量に基づいてそれぞれのパネルの開き方をコントロールしてみましょう。Revit でビューを拡大表示して 1 つのパネルを選択すると、プロパティ バーに[_開口率_]というパラメータが表示されます。ファミリは、開口率の範囲が _0.05_ ～ _0.45_ になるように設定されています。

> 1. 太陽の軌道の表示をオンにすると、Revit で現在の太陽の位置を確認することができます。

> 1. _SunSettings.Current_ ノードを使用すると、この太陽の位置を参照することができます。

1. そのノードの SunSettings の出力を _Sunsetting.SunDirection_ ノードの入力に接続し、太陽光のベクトルを取得します。
2. アダプティブ コンポーネントの作成に使用した _Panel Pts_ からの出力を、_Plane.ByBestFitThroughPoints_ ノードを使用して、そのコンポーネントのために平面に近づけます。
3. この平面の_法線_のクエリーを実行します。
4. _内積_を使用して太陽の向きを計算します。内積に基づいて、2 つのベクトルが平行であるかどうかを判定することができます。つまり、各アダプティブ コンポーネントの平面法線を取得し、それと太陽光のベクトルを比較することで、太陽の向きをおおまかにシミュレートします。
5. 結果の_絶対値_を取得します。これにより、平面法線が逆方向を向いている場合に正確な内積が算出されます。
6. [_実行_]をクリックします。

> 1. _内積_を確認すると、複数の数値が広範囲にわたって取得されています。これからその相対分布を使用するのですが、しかしそれらの数値を集約して[_開口率_]の適切な範囲に収めなければなりません。

1. これにたいへん役立つツールが _Math.RemapRange_ ノードです。そのノードにリストを入力し、その分布範囲を 2 つの目標値にマッピングし直します。
2. 目標値を _Code Block_ ノードで _0.15_ と _0.45_ として定義します。
3. [_実行_]をクリックします。

> 1. マッピングし直した値を _Element.SetParameterByName_ ノードに接続します。

1. そのノードの _parameterName_ 入力に、「_Aperture Ratio_」という文字列を接続します。
2. 同じノードの _element_ 入力に、AdaptiveComponent.ByPoints ノードの _Adaptive Components_ 出力を接続します。
3. [_実行_]をクリックします。

> Revit に戻って建物のマスを遠くから見てみると、ETFE パネルの開き方が太陽の向きによって変化していることが確認できます。

> 拡大表示すると、太陽により向き合っているパネルほどより閉じていることがわかります。太陽光の照射による過熱を抑えることがねらいです。太陽光をたくさん浴びている面ほどより多く採光するように設定するには、ただ _Math.RemapRange_ ノードで範囲を逆に切り替えるだけで済みます。
